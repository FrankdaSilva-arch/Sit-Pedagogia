{% extends 'loja/base.html' %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Histórico de Acessos</h2>
    
    <div class="card">
        <div class="card-body p-0">
            <div class="chart-scroll-container">
                <div class="chart-container">
                    <canvas id="logsChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .chart-scroll-container {
        position: relative;
        width: 100%;
        overflow-x: auto;
        overflow-y: hidden;
        padding: 15px;
    }

    .chart-container {
        position: relative;
        height: 400px;
        min-width: 1500px;
        width: 100%;
        background-color: white;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .chart-container canvas {
        width: 100%;
        height: 100%;
        display: block;
    }

    /* Estilização da barra de rolagem */
    .chart-scroll-container::-webkit-scrollbar {
        height: 12px;
        background-color: #f5f5f5;
    }

    .chart-scroll-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 6px;
        box-shadow: inset 0 0 6px rgba(0,0,0,0.1);
    }

    .chart-scroll-container::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 6px;
        box-shadow: inset 0 0 6px rgba(0,0,0,0.3);
    }

    .chart-scroll-container::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    /* Firefox */
    .chart-scroll-container {
        scrollbar-width: thin;
        scrollbar-color: #888 #f1f1f1;
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script>
    let chart = null;
    const ctx = document.getElementById('logsChart').getContext('2d');

    function getPrimeiroESegundoNome(nomeCompleto) {
        const partes = nomeCompleto.split(' ');
        if (partes.length >= 2) {
            return `${partes[0]} ${partes[1]}`;
        }
        return nomeCompleto;
    }

    function atualizarGrafico() {
        fetch('/logs-acesso-json/')
            .then(response => response.json())
            .then(data => {
                // Ordena os dados por data
                data.sort((a, b) => new Date(a.data_acesso) - new Date(b.data_acesso));

                // Prepara os datasets
                const datasets = [];
                const cores = [
                    'rgba(75, 192, 192, 0.5)',
                    'rgba(54, 162, 235, 0.5)',
                    'rgba(255, 206, 86, 0.5)',
                    'rgba(153, 102, 255, 0.5)',
                    'rgba(255, 159, 64, 0.5)'
                ];

                // Cria os datasets para cada tipo de dado
                const datasetDisponiveis = {
                    label: 'Moedas Disponíveis',
                    data: [],
                    backgroundColor: [],
                    borderColor: [],
                    borderWidth: 1
                };

                const datasetUsadas = {
                    label: 'Moedas Usadas',
                    data: [],
                    backgroundColor: 'rgba(255, 99, 132, 0.5)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1
                };

                // Prepara os labels e dados
                const labels = [];
                const usuarios = new Set();
                let corIndex = 0;

                data.forEach((log, index) => {
                    const nome = getPrimeiroESegundoNome(log.usuario);
                    const [data, hora] = log.data_acesso.split(' ');
                    
                    labels.push(`${nome}\n${data}\n${hora}`);
                    datasetDisponiveis.data.push(log.moedas_disponiveis);
                    datasetUsadas.data.push(log.moedas_usadas);

                    if (!usuarios.has(nome)) {
                        usuarios.add(nome);
                        corIndex = usuarios.size - 1;
                    }
                    datasetDisponiveis.backgroundColor.push(cores[corIndex % cores.length]);
                    datasetDisponiveis.borderColor.push(cores[corIndex % cores.length]);
                });

                datasets.push(datasetDisponiveis);
                datasets.push(datasetUsadas);

                // Destrói o gráfico anterior se existir
                if (chart) {
                    chart.destroy();
                }

                // Cria o novo gráfico
                console.log("Criando novo gráfico com dados:", {
                    labels: labels,
                    datasets: datasets
                });

                chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Número de Moedas'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Usuário e Data/Hora'
                                },
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45,
                                    padding: 10,
                                    font: {
                                        size: 12,
                                        weight: 'bold'
                                    }
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'Histórico de Uso de Moedas por Usuário'
                            },
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            datalabels: {
                                anchor: 'center',
                                align: 'center',
                                formatter: function(value) {
                                    return value;
                                },
                                font: {
                                    weight: 'bold',
                                    size: 12
                                },
                                color: '#000'
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });

                // Ajusta o tamanho do canvas e container
                const canvas = document.querySelector('canvas');
                const container = document.querySelector('.chart-container');
                const minWidth = Math.max(1500, labels.length * 150);
                
                // Aplica os estilos necessários
                canvas.style.minWidth = `${minWidth}px`;
                container.style.minWidth = `${minWidth}px`;
                
                // Força a atualização da barra de rolagem
                setTimeout(() => {
                    container.scrollLeft = 0;
                    console.log("\n=== Barra de rolagem ===");
                    console.log("Barra de rolagem horizontal presente:", container.scrollWidth > container.offsetWidth);
                    console.log("Largura total do conteúdo:", container.scrollWidth, "px");
                    console.log("Largura do canvas:", canvas.offsetWidth, "px");
                }, 100);
            })
            .catch(error => {
                console.error("Erro ao atualizar gráfico:", error);
            });
    }

    // Atualiza o gráfico a cada 30 segundos
    atualizarGrafico();
    setInterval(atualizarGrafico, 30000);
</script>
{% endblock %} 